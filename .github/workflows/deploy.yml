name: Deploy to Home Server

on:
  push:
    branches:
      - main # main 브랜치에 push 시 자동 배포
      # - dev  # dev 브랜치도 배포하려면 주석 해제
  workflow_dispatch: # 수동 실행 가능

jobs:
  # 린트 및 타입 체크
  lint-and-typecheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint
        continue-on-error: true # 린트 에러가 있어도 배포 계속 진행

      # 타입 체크가 필요한 경우 주석 해제
      # - name: Type check
      #   run: npx tsc --noEmit

  # Docker 이미지 빌드 및 푸시
  build-and-push:
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # 홈서버 배포
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Deploy to Home Server via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 2022 }}
          script: |
            # 프로젝트 디렉토리로 이동
            cd ~/unisize-front

            # GitHub Container Registry 로그인
            echo ${{ secrets.GHCR_PAT }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # 최신 이미지 pull 및 실행
            docker-compose pull
            docker-compose down
            docker-compose up -d

            # 로그 확인 (최근 20줄)
            docker-compose logs --tail=20

            # 컨테이너 상태 확인
            docker ps | grep unisize-front

            # 사용하지 않는 이미지 정리
            docker image prune -f

  # Slack/Discord 알림 (선택사항)
  # notify:
  #   runs-on: ubuntu-latest
  #   needs: deploy
  #   if: always()
  #   steps:
  #     - name: Send notification
  #       run: |
  #         if [ "${{ needs.deploy.result }}" == "success" ]; then
  #           echo "배포 성공!"
  #           # Slack/Discord webhook 호출
  #         else
  #           echo "배포 실패!"
  #         fi
