name: Deploy to Home Server

on:
  # ì´ì „ ì›Œí¬í”Œë¡œìš°(Build & Test)ê°€ ì™„ë£Œëœ í›„ì—ë§Œ ì‹¤í–‰
  workflow_run:
    workflows: ["Build & Test"]
    types: [completed]
    branches: [main]
  # ìˆ˜ë™ ë°°í¬ íŠ¸ë¦¬ê±°
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    name: Deploy to Home Server
    # workflow_runì—ì„œ íŠ¸ë¦¬ê±°ëœ ê²½ìš°, CI/CD ì›Œí¬í”Œë¡œìš°ê°€ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.SSH_PORT || '2022' }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to server
        run: |
          echo "ğŸš€ Starting deployment..."

          SSH_CMD="ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT || '2022' }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}"

          # Test connection
          $SSH_CMD "echo 'Connected to server'"

          # Verify docker-compose file exists
          $SSH_CMD "ls -la ~/unisize-front/docker-compose.yml"

          # Deploy with automatic docker login
          $SSH_CMD "cd ~/unisize-front && echo '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u ${{ github.actor }} --password-stdin && docker-compose pull && docker-compose down || true && docker-compose up -d && docker logout ghcr.io"

          echo "âœ… Deployment completed"

      - name: Check container status
        run: |
          echo "ğŸ” Checking container status..."

          SSH_CMD="ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT || '2022' }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}"

          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          $SSH_CMD "docker ps | grep unisize-front"

          # ìµœê·¼ ë¡œê·¸ í™•ì¸
          $SSH_CMD "cd ~/unisize-front && docker-compose logs --tail=20"

          # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
          $SSH_CMD "docker image prune -f"

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

      - name: Deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Deployment successful!"
            echo "Frontend: http://${{ secrets.SSH_HOST }}"
          else
            echo "âŒ Deployment failed!"
          fi

  # Slack/Discord ì•Œë¦¼ (ì„ íƒì‚¬í•­)
  # notify:
  #   runs-on: ubuntu-latest
  #   needs: deploy
  #   if: always()
  #   steps:
  #     - name: Send notification
  #       run: |
  #         if [ "${{ needs.deploy.result }}" == "success" ]; then
  #           echo "ë°°í¬ ì„±ê³µ!"
  #           # Slack/Discord webhook í˜¸ì¶œ
  #         else
  #           echo "ë°°í¬ ì‹¤íŒ¨!"
  #         fi
