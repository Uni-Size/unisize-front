name: Deploy to Home Server

on:
  # Ïù¥Ï†Ñ ÏõåÌÅ¨ÌîåÎ°úÏö∞(CI/CD)Í∞Ä ÏôÑÎ£åÎêú ÌõÑÏóêÎßå Ïã§Ìñâ
  workflow_run:
    workflows: ["Build & Test"]
    types: [completed]
    branches: [main]
  # ÏàòÎèô Î∞∞Ìè¨ Ìä∏Î¶¨Í±∞
  workflow_dispatch:
    inputs:
      force_deploy:
        description: "Force deployment"
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    name: Deploy to Home Server
    # workflow_runÏóêÏÑú Ìä∏Î¶¨Í±∞Îêú Í≤ΩÏö∞, CI/CD ÏõåÌÅ¨ÌîåÎ°úÏö∞Í∞Ä ÏÑ±Í≥µÌñàÏùÑ ÎïåÎßå Ïã§Ìñâ
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.SSH_PORT || '2022' }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to server
        run: |
          echo "üöÄ Starting deployment..."

          SSH_CMD="ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT || '2022' }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}"
          DEPLOY_PATH="/opt/unisize/frontend"

          # Test connection
          $SSH_CMD "echo 'Connected to server'"

          # Create deploy directory if not exists
          echo "üìÅ Creating deployment directory..."
          $SSH_CMD "mkdir -p ${DEPLOY_PATH}"

          # Copy all necessary files to server
          echo "üì§ Uploading files..."
          rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT || '2022' }}" \
            --exclude 'node_modules' \
            --exclude '.next' \
            --exclude '.git' \
            ./ ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:${DEPLOY_PATH}/

          # Build and deploy on server
          echo "üê≥ Building and deploying containers on server..."
          $SSH_CMD "cd ${DEPLOY_PATH} && \
            docker-compose -f docker-compose.yml down || true && \
            docker-compose -f docker-compose.yml build --build-arg NEXT_PUBLIC_API_BASE_URL=${{ secrets.NEXT_PUBLIC_API_BASE_URL }} && \
            docker-compose -f docker-compose.yml up -d"

          echo "‚úÖ Deployment completed"

      - name: Health check
        run: |
          echo "üß™ Running health check..."

          for i in {1..30}; do
            echo "Attempt $i/30..."
            if curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SSH_HOST }}:3000 | grep -q "200"; then
              echo "‚úÖ Health check passed"
              exit 0
            fi
            sleep 2
          done

          echo "‚ùå Health check failed"
          exit 1

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

      - name: Deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Deployment successful!"
            echo "Frontend: http://${{ secrets.SSH_HOST }}:3000"
          else
            echo "‚ùå Deployment failed!"
          fi
